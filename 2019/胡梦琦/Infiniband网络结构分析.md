# Infiniband网络结构分析
***
## 目录
* 概述
* 产生原因
* Infiniband的协议层次
* Infiniband的网络结构

## 概述

InfiniBand是一个用于高性能计算的计算机网络通信标准，它具有极高的吞吐量和极低的延迟，用于计算机与计算机之间的数据互连。InfiniBand也用作服务器与存储系统之间的直接或交换互连，以及存储系统之间的互连。  
Infiniband采用PCI串行高速带宽链接，从SDR、DDR、QDR、FDR到EDR HCA连接，可以做到1微妙、甚至纳米级别极低的时延，基于链路层的流控机制实现先进的拥塞控制。  
InfiniBand采用虚通道方式来实现QoS，虚通道是一些共享一条物理链接的相互分立的逻辑通信链路，每条物理链接可支持多达15条的标准虚通道和一条管理通道。
## 产生原因
随着CPU性能的飞速发展，I/O系统的性能成为制约服务器性能的瓶颈。于是人们开始重新审视使用了十几年的PCI总线架构。虽然PCI总线结构把数据的传输从8位/16位一举提升到32位，甚至当前的64位，但是它的一些先天劣势限制了其继续发展的势头。PCI总线有如下缺陷：
  
	1. 由于采用了基于总线的共享传输模式，在PCI总线上不可能同时传送两组以上的数据。 
	2. 随着总线频率的提高，信号线之间的相互干扰变得越来越严重，在一块主板上布设多条总线的难度也就
	越来越大。
	3. 由于PCI设备采用了内存映射I/O地址的方式建立与内存的联系，热添加PCI设备变成了一件非常困难的
	工作。
	4. PCI的总线上虽然有buffer作为数据的缓冲区，但是它不具备纠错的功能。
 

因此，Intel、 Cisco、 Compaq、 EMC、 富士通等公司共同发起了infiniband架构，其目的是为了取代PCI成为系统互连的新技术标准，其核心就是将I/O系统从服务器主机中分离出来。  
InfiniBand 采用双队列程序提取技术,使应用程序直接将数据从适配器 送入到应用内存(称为远程直接存储器存取或RDMA), 反之依然。在TCP/IP协议中,来自网卡的数据先拷贝到 核心内存,然后再拷贝到应用存储空间,或从应用空间 将数据拷贝到核心内存,再经由网卡发送到Internet。这 种I/O操作方式,始终需要经过核心内存的转换,它不 仅增加了数据流传输路径的长度,而且大大降低了I/O 的访问速度,增加了CPU的负担。而SDP则是将来自网 卡的数据直接拷贝到用户的应用空间,从而避免了核心 内存参入。这种方式就称为零拷贝,它可以在进行大量 数据处理时,达到该协议所能达到的最大的吞吐量。  

##Infiniband的协议层次

Infiniband的协议采用分层结构，各个层次之间相互独立，负责不同的功能，下层为上层提供服务。  

![alt 图标](https://github.com/MQ-Hu/hello-world/blob/master/images/3.1.png)

#### 1、物理层
      物理层定义了电气特性和机械特性，包括光纤和铜媒介的电缆和插座、底板连接器、热交换特性等。定义了背板、电缆、光缆三种物理端口。  
      定义了在线路上如何将比特信号组成符号,然后再组成帧、 数据符号以及包之间的数据填充等,详细说明了构建有效包的信令协议等

#### 2、链路层
      链路层描述了数据包的格式和数据包操作的协议，如流量控制和子网内数据包的路由。链路层有链路管理数据包和数据包两种类型的数据包。

#### 3、 网络层
      网络层是子网间转发数据包的协议，类似于IP网络中的网络层。实现子网间的数据路由，数据在子网内传输时不需网络层的参与。  
      数据包中包含全局路由头GRH（一个40字节的全局的路由报头），用于子网间数据包路由转发，在转发的过程中,路由器仅仅进行可变的CRC校验,这样就保证了端到端的数据传输的完整性。全局路由头部指明了使用IPv6地址格式的全局标识符(GID)的源端口和目的端口，路由器基于GRH进行数据包转发。GRH采用IPv6报头格式。GID由每个子网唯一的子网标示符和端口GUID捆绑而成。

#### 4、 传输层
      传输层负责报文的分发、通道多路复用、基本传输服务和处理报文分段的发送、接收和重组。传输层的功能是将数据包传送到各个指定的队列(QP)中，并指示队列如何处理该数据包。当消息的数据路径负载大于路径的最大传输单元(MTU)时，传输层负责将消息分割成多个数据包。  
      接收端的队列负责将数据重组到指定的数据缓冲区中。除了原始数据报外，所有的数据包都包含BTH，BTH指定目的队列并指明操作类型、数据包序列号和分区信息。

#### 5、上层协议
      InfiniBand为不同类型的用户提供了不同的上层协议，并为某些管理功能定义了消息和协议。InfiniBand主要支持SDP、SRP、iSER、RDS、IPoIB和uDAPL等上层协议。

## Infiniband的网络结构

![alt 图标](https://github.com/MQ-Hu/hello-world/blob/master/images/3.2.png)  
Infiniband的网络拓扑结构如图，其组成单元主要分为四类：  
（1）HCA（Host Channel Adapter），它是连接内存控制器和TCA的桥梁；  
（2）TCA(Target Channel Adapter)，它将I/O设备（例如网卡、SCSI控制器）的数字信号打包发送给HCA；  
（3）Infiniband link，它是连接HCA和TCA的光纤，InfiniBand架构允许硬件厂家以1条、4条、12条光纤3种方式连结TCA和HCA；  
（4）交换机和路由器；  
